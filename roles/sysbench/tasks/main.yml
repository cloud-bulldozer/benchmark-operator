---
- name: Get current state
  k8s_info:
    api_version: ripsaw.cloudbulldozer.io/v1alpha1
    kind: Benchmark
    name: '{{ ansible_operator_meta.name }}'
    namespace: '{{ operator_namespace }}'
  register: resource_state

- name: Set building state
  include_role:
    name: benchmark_state
    tasks_from: building.yml

- block:
  - name: template sysbench script
    k8s:
      definition:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: 'sysbench-config-{{ trunc_uuid }}'
          namespace: '{{ operator_namespace }}'
        data:
          sysbenchScript: "{{ lookup('template', 'sysbench.sh.j2') }}"

  - name: Start sysbench job
    k8s:
      state: present
      definition: "{{ lookup('template', 'workload.yml') | from_yaml }}"
    when: workload_args.kind is not defined

  - name: Start sysbench vm job
    k8s:
      state: present
      definition: "{{ lookup('template', 'workload_vm.yml') | from_yaml }}"
    when:  workload_args.kind is defined and workload_args.kind == "vm"

  - operator_sdk.util.k8s_status:
      api_version: ripsaw.cloudbulldozer.io/v1alpha1
      kind: Benchmark
      name: "{{ ansible_operator_meta.name }}"
      namespace: "{{ operator_namespace }}"
      status:
        state: Running
        complete: false

  when: resource_state.resources[0].status.state == "Building"

- name: Set completed state
  include_role:
    name: benchmark_state
    tasks_from: completed.yml
