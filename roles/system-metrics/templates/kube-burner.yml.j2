---
kind: Job
apiVersion: batch/v1
metadata:
  name: system-metrics-collector-{{ trunc_uuid }}
  namespace: {{ operator_namespace }}
spec:
  backoffLimit: 0
  activeDeadlineSeconds: 3600
  template:
    metadata:
      labels:
        app: system-metrics-collector-{{ trunc_uuid }}
    spec:
{% if workload_args.runtime_class is defined %}
      runtimeClassName: "{{ workload_args.runtime_class }}"
{% endif %}
      restartPolicy: Never
      containers:
      - name: kube-burner
        image: quay.io/cloud-bulldozer/kube-burner:latest
        imagePullPolicy: Always
        workingDir: /tmp/kube-burner
        command: ["/bin/sh", "-c"]
        args:
        - >
          kube-burner index
          --uuid={{ uuid }}
          -c index.yml
          -u {{ prometheus.prom_url|default("https://prometheus-k8s.openshift-monitoring.svc.cluster.local:9091") }}
          -t {{ prometheus.prom_token }}
          --start={{ (cr_state.resources[0].metadata.creationTimestamp|to_datetime('%Y-%m-%dT%H:%M:%SZ')).strftime('%s') }}
          --end=$(date +%s)
          -m {{ prometheus.metrics_profile|default("metrics.yml") }}
          --step={{ workload_args.step|default("30s") }}
        volumeMounts:
          - name: system-metrics-collector
            mountPath: /tmp/kube-burner
      volumes:
        - name: system-metrics-collector
          configMap:
            name: system-metrics-collector-{{ trunc_uuid }}
